<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NZ Property Value Finder</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/styles/main.css">
    <meta name="description" content="Quickly find New Zealand property values and insights from Homes.co.nz, OneRoof, QV, RealEstate.co.nz, TradeMe, and PropertyValue.co.nz. Get estimated values, sales history, and more.">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0910314329433856"
          crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V5892WKB8E"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-V5892WKB8E');
</script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0910314329433856"
     crossorigin="anonymous"></script>
</head>
<body>
    <header class="site-header sticky top-0 z-50 bg-white shadow-md py-4">
        <div class="container mx-auto flex flex-col md:flex-row items-center justify-between px-4">
            <h1 class="site-title text-2xl font-bold text-gray-800 mb-3 md:mb-0 md:mr-4">
                <a href="/" class="text-gray-800 hover:no-underline">NZ Property Value Finder</a>
            </h1>
            <div class="header-search-wrapper flex items-center w-full md:w-auto">
                <input type="text" id="addressInput" placeholder="Enter an address, e.g., 10 Downing Street, London" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mr-2">
                <button id="searchButton" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition ease-in-out duration-150">
                    <span class="long-text">Search Property</span>
                    <span class="short-text">Search</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto mt-8 px-4">
        <section id="introductoryText" class="text-center text-gray-600 mb-8 max-w-2xl mx-auto">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Welcome to NZ Property Value Finder</h2>
            <p class="mb-4">
                Instantly access property information from New Zealand's top real estate websites.
                Simply enter an address to find estimated values, sales history, and more, all in one place.
            </p>
            <p>
                We aggregate data from <span class="font-medium text-gray-700">Homes.co.nz, OneRoof, QV, RealEstate.co.nz, TradeMe, and PropertyValue.co.nz</span> to give you a comprehensive overview.
            </p>
        </section>

        <div id="loadingSpinner" class="text-center mt-10" style="display: none;">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto"></div>
            <p class="text-gray-600 mt-3">Loading property data...</p>
        </div>

        <div id="errorMessage" class="text-center text-red-600 mt-4" style="display: none;"></div>

        <section id="resultsSection" style="display: none;" class="mt-8">
            <div id="summaryDataContainer" class="bg-white p-6 rounded-lg shadow-md mb-8 flex flex-col md:flex-row items-center" style="display: none;">
                <div id="summaryPhotoWrapper" class="w-full md:w-1/3 flex-shrink-0 mb-4 md:mb-0 md:mr-6">
                    <img id="summaryPropertyPhoto" src="" alt="Property Photo" class="w-full h-auto rounded-lg shadow-sm" style="display: none;">
                </div>
                
                <div id="summaryDetails" class="flex-grow">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Property Summary (<span id="summaryAddress"></span>)</h3>
                    <div id="summaryLastSold" class="text-gray-700 text-lg mb-2" style="display: none;">
                        <p class="font-medium">Last Sold: <span id="lastSoldValue" class="font-bold"></span></p>
                    </div>

                    <div id="summaryValuationData" class="mt-4 border-t border-gray-200 pt-4" style="display: none;">
                        <p class="text-gray-700 text-md">Capital Value: <span id="capitalValue" class="font-semibold text-gray-900"></span></p>
                        <p class="text-gray-700 text-md">Land Value: <span id="landValue" class="font-semibold text-gray-900"></span></p>
                        <p class="text-gray-700 text-md">Improvement Value: <span id="improvementValue" class="font-semibold text-gray-900"></span></p>
                        <p class="text-gray-700 text-md">Valuation Date: <span id="valuationDate" class="font-semibold text-gray-900"></span></p>
                    </div>
                </div>
            </div>

            <div id="estimatedValuesSummary" class="bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-4 rounded-lg shadow-md mb-8" role="alert" style="display: none;">
                <p class="font-bold text-lg mb-2">Estimated Value Summary:</p>
                <div id="summaryValuesContent" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    </div>
                <p class="text-sm mt-4 text-blue-700">
                    These are estimated median values aggregated from available sources. For detailed information, please visit the individual property websites below.
                </p>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-5">Property Links & Estimated Values</h2>
            
            <div class="overflow-x-auto">
                <table id="estimatedValuesTable" class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr class="bg-gray-100 text-left text-sm text-gray-600 uppercase tracking-wider">
                            <th class="py-3 px-4 border-b border-gray-200">Source</th>
                            <th class="py-3 px-4 border-b border-gray-200">Low</th>
                            <th class="py-3 px-4 border-b border-gray-200">Median</th>
                            <th class="py-3 px-4 border-b border-gray-200">High</th>
                        </tr>
                    </thead>
                    <tbody id="estimatedValuesTableBody">
                        </tbody>
                </table>
            </div>

            <div id="propertyLinks" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
                </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white py-6 mt-10">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2024 NZ Property Value Finder. All rights reserved.</p>
            <p class="text-sm mt-2">Data provided by third-party sources. Always verify information on the respective websites.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const addressInput = document.getElementById('addressInput');
            const searchButton = document.getElementById('searchButton');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const errorMessage = document.getElementById('errorMessage');
            const resultsSection = document.getElementById('resultsSection');
            const propertyLinksContainer = document.getElementById('propertyLinks');
            const estimatedValuesTableBody = document.getElementById('estimatedValuesTableBody');
            const summaryDataContainer = document.getElementById('summaryDataContainer');
            const summaryPropertyPhoto = document.getElementById('summaryPropertyPhoto');
            const summaryLastSold = document.getElementById('summaryLastSold');
            const lastSoldValue = document.getElementById('lastSoldValue');
            const summaryAddress = document.getElementById('summaryAddress');
            const summaryValuationData = document.getElementById('summaryValuationData');
            const capitalValueSpan = document.getElementById('capitalValue');
            const landValueSpan = document.getElementById('landValue');
            const improvementValueSpan = document.getElementById('improvementValue');
            const valuationDateSpan = document.getElementById('valuationDate');
            const estimatedValuesSummary = document.getElementById('estimatedValuesSummary');
            const summaryValuesContent = document.getElementById('summaryValuesContent');
            const introductoryText = document.getElementById('introductoryText');


            let autocomplete;

            // Initialize Google Autocomplete
            function initAutocomplete() {
                // Ensure the Google Maps Places API script is loaded before initializing
                if (typeof google === 'undefined' || typeof google.maps === 'undefined' || typeof google.maps.places === 'undefined') {
                    console.warn('Google Maps Places API not loaded. Retrying in 500ms...');
                    setTimeout(initAutocomplete, 500); // Retry after 500ms
                    return;
                }

                autocomplete = new google.maps.places.Autocomplete(addressInput, {
                    bounds: new google.maps.LatLngBounds(
                        new google.maps.LatLng(-47.3, 166.3), // Southwest NZ
                        new google.maps.LatLng(-34.3, 178.6)  // Northeast NZ
                    ),
                    strictBounds: true,
                    componentRestrictions: { country: 'nz' },
                    fields: ['formatted_address', 'place_id', 'geometry'],
                    types: ['address']
                });

                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (place.formatted_address) {
                        addressInput.value = place.formatted_address;
                        searchButton.disabled = false; // Enable search button
                    } else {
                        searchButton.disabled = true; // Keep disabled if no valid address
                    }
                });

                // Disable search button by default
                searchButton.disabled = true;

                // Re-enable search button if user types and then selects an autocomplete suggestion
                addressInput.addEventListener('input', () => {
                    // Disable button if input is cleared or doesn't match a selection
                    if (!addressInput.value) {
                        searchButton.disabled = true;
                    }
                });
            }

            // Dynamically load Google Maps Places API
            const googleMapsScript = document.createElement('script');
            googleMapsScript.src = `https://maps.googleapis.com/maps/api/js?key=${process.env.NEXT_PUBLIC_Maps_API_KEY}&libraries=places&callback=initAutocomplete`;
            googleMapsScript.async = true;
            googleMapsScript.defer = true;
            document.head.appendChild(googleMapsScript);

            // Make sure initAutocomplete is globally accessible
            window.initAutocomplete = initAutocomplete;

            searchButton.addEventListener('click', async () => {
                const address = addressInput.value.trim();

                if (!address) {
                    errorMessage.textContent = 'Please enter a valid address.';
                    errorMessage.style.display = 'block';
                    resultsSection.style.display = 'none';
                    introductoryText.style.display = 'block'; // Show introductory text again
                    return;
                }

                loadingSpinner.style.display = 'block';
                errorMessage.style.display = 'none';
                resultsSection.style.display = 'none';
                propertyLinksContainer.innerHTML = ''; // Clear previous links
                estimatedValuesTableBody.innerHTML = ''; // Clear previous table data
                summaryDataContainer.style.display = 'none'; // Hide summary
                summaryPropertyPhoto.style.display = 'none';
                summaryLastSold.style.display = 'none';
                summaryValuationData.style.display = 'none';
                estimatedValuesSummary.style.display = 'none';
                summaryValuesContent.innerHTML = '';
                introductoryText.style.display = 'none'; // Hide introductory text


                try {
                    const apiEndpoints = [
                        { name: 'Homes.co.nz', url: '/api/get-homes-url', favicon: 'https://homes.co.nz/favicon.ico', scrape: true, scrapeApi: '/api/scrape-homes-values' },
                        { name: 'OneRoof.co.nz', url: '/api/get-oneroof-url', favicon: 'https://www.oneroof.co.nz/favicon.ico', scrape: true, scrapeApi: '/api/scrape-oneroof-values' },
                        { name: 'QV.co.nz', url: '/api/get-qv-url', favicon: 'https://content.quotablevalue.co.nz/static/favicon.ico', scrape: false },
                        { name: 'RealEstate.co.nz', url: '/api/get-realestate-url', favicon: 'https://www.realestate.co.nz/favicon.ico', scrape: true, scrapeApi: '/api/scrape-realestate-values' }, // New RealEstate
                        { name: 'TradeMe.co.nz', url: '/api/get-trademe-url', favicon: 'https://www.trademe.co.nz/favicon.ico', scrape: true, scrapeApi: '/api/scrape-trademe-values' }, // New TradeMe
                        { name: 'PropertyValue.co.nz', url: '/api/get-propertyvalue-url', favicon: 'https://www.propertyvalue.co.nz/static/media/favicon.ico', scrape: false, returnData: true } // Modified to return data directly
                    ];

                    let anyLinkGenerated = false;
                    let pvDataFound = false; // Flag for PropertyValue.co.nz data
                    let mediumValues = []; // Array to hold medium values for summary

                    // Use Promise.allSettled to allow all API calls to complete independently
                    const results = await Promise.allSettled(
                        apiEndpoints.map(async (endpoint) => {
                            try {
                                const response = await fetch(endpoint.url, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ address })
                                });

                                const data = await response.json();

                                if (!response.ok) {
                                    throw new Error(data.error || `Failed to get URL for ${endpoint.name}`);
                                }

                                const linkUrl = data.url;
                                const scrapedData = data.data; // For PropertyValue.co.nz

                                // Handle PropertyValue.co.nz data specifically
                                if (endpoint.name === 'PropertyValue.co.nz' && scrapedData) {
                                    pvDataFound = true;
                                    summaryAddress.textContent = address; // Set address in summary
                                    
                                    if (scrapedData.propertyPhotoSrc && scrapedData.propertyPhotoSrc !== 'N/A') {
                                        summaryPropertyPhoto.src = scrapedData.propertyPhotoSrc;
                                        summaryPropertyPhoto.style.display = 'block';
                                    } else {
                                        summaryPropertyPhoto.style.display = 'none'; // Hide if no photo
                                    }
                                    
                                    if (scrapedData.lastSold && scrapedData.lastSold !== 'N/A') {
                                        lastSoldValue.textContent = scrapedData.lastSold;
                                        summaryLastSold.style.display = 'block';
                                    } else {
                                        summaryLastSold.style.display = 'none'; // Hide if no last sold info
                                    }

                                    // Display valuation data
                                    if (scrapedData.capitalValue !== 'N/A' || scrapedData.landValue !== 'N/A' || scrapedData.improvementValue !== 'N/A' || scrapedData.valuationDate !== 'N/A') {
                                        capitalValueSpan.textContent = scrapedData.capitalValue;
                                        landValueSpan.textContent = scrapedData.landValue;
                                        improvementValueSpan.textContent = scrapedData.improvementValue;
                                        valuationDateSpan.textContent = scrapedData.valuationDate;
                                        summaryValuationData.style.display = 'block';
                                    } else {
                                        summaryValuationData.style.display = 'none';
                                    }
                                }

                                if (linkUrl) {
                                    anyLinkGenerated = true;

                                    let lowValue = 'N/A';
                                    let mediumValue = 'N/A';
                                    let highValue = 'N/A';

                                    // If scraping is enabled for this endpoint
                                    if (endpoint.scrape && endpoint.scrapeApi) {
                                        try {
                                            const scrapeResponse = await fetch(endpoint.scrapeApi, {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ url: linkUrl })
                                            });

                                            const scrapeData = await scrapeResponse.json();

                                            if (scrapeResponse.ok && scrapeData.estimatedValues) {
                                                lowValue = scrapeData.estimatedValues.low || 'N/A';
                                                mediumValue = scrapeData.estimatedValues.medium || 'N/A';
                                                highValue = scrapeData.estimatedValues.high || 'N/A';
                                            } else {
                                                console.warn(`Scraping failed for ${endpoint.name}:`, scrapeData.error || 'Unknown error');
                                            }
                                        } catch (scrapeError) {
                                            console.error(`Error during scraping for ${endpoint.name}:`, scrapeError);
                                        }
                                    } else if (endpoint.name === 'PropertyValue.co.nz' && scrapedData) {
                                        // Use direct data for PropertyValue.co.nz if available
                                        lowValue = scrapedData.estimatedValueLow || 'N/A';
                                        mediumValue = scrapedData.estimatedValueMedium || 'N/A';
                                        highValue = scrapedData.estimatedValueHigh || 'N/A';
                                    }

                                    // Populate the table
                                    const row = estimatedValuesTableBody.insertRow();
                                    row.className = 'text-sm text-gray-800'; // Apply consistent styling
                                    
                                    const sourceCell = row.insertCell();
                                    sourceCell.className = 'py-2 px-4 border-b border-gray-200 flex items-center'; // Added flex items-center for alignment
                                    sourceCell.innerHTML = `
                                        <a href="${linkUrl}" target="_blank" rel="noopener noreferrer" class="flex items-center text-blue-700 hover:underline font-medium">
                                            <img src="${endpoint.favicon}" alt="${endpoint.name} favicon" class="site-favicon mr-2">
                                            ${endpoint.name}
                                        </a>
                                    `;

                                    const lowCell = row.insertCell();
                                    lowCell.className = `py-2 px-4 border-b border-gray-200 ${lowValue === 'N/A' ? '' : 'bold-value'}`;
                                    lowCell.textContent = lowValue;

                                    const mediumCell = row.insertCell();
                                    mediumCell.className = `py-2 px-4 border-b border-gray-200 ${mediumValue === 'N/A' ? '' : 'bold-value'}`;
                                    mediumCell.textContent = mediumValue;

                                    const highCell = row.insertCell();
                                    highCell.className = `py-2 px-4 border-b border-gray-200 ${highValue === 'N/A' ? '' : 'bold-value'}`;
                                    highCell.textContent = highValue;

                                    if (mediumValue !== 'N/A' && mediumValue !== 'Error') {
                                        mediumValues.push({ name: endpoint.name, value: mediumValue });
                                    }

                                }
                                return { status: 'fulfilled', value: { name: endpoint.name, url: linkUrl, scrapedData: scrapedData, values: { low: lowValue, medium: mediumValue, high: highValue } } };
                            } catch (error) {
                                console.error(`Error for ${endpoint.name}:`, error.message);
                                // Optionally, add a row to the table indicating an error
                                const row = estimatedValuesTableBody.insertRow();
                                row.className = 'text-sm text-gray-800 bg-red-50';
                                row.innerHTML = `
                                    <td class="py-2 px-4 border-b border-gray-200 flex items-center">
                                        <img src="${endpoint.favicon}" alt="${endpoint.name} favicon" class="site-favicon mr-2">
                                        ${endpoint.name}
                                    </td>
                                    <td colspan="3" class="py-2 px-4 border-b border-gray-200 text-red-600">
                                        ${error.message.includes('No property ID found') || error.message.includes('No direct') || error.message.includes('No results') || error.message.includes('URL not found') ? 'Address not found or no direct link available.' : 'Failed to retrieve data.'}
                                    </td>
                                `;
                                return { status: 'rejected', reason: { name: endpoint.name, error: error.message } };
                            }
                        })
                    );

                    // Sort medium values for summary display (e.g., lowest to highest)
                    mediumValues.sort((a, b) => {
                        const parseValue = (val) => parseFloat(val.replace(/[^0-9.]/g, ''));
                        return parseValue(a.value) - parseValue(b.value);
                    });

                    // Display summary values
                    if (mediumValues.length > 0) {
                        const summaryContentHtml = `
                            <div class="flex flex-col">
                                <span class="text-sm text-blue-700">Lowest Median:</span>
                                <span class="font-bold text-lg">${mediumValues[0].value} <span class="text-base font-normal">(${mediumValues[0].name})</span></span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-sm text-blue-700">Highest Median:</span>
                                <span class="font-bold text-lg">${mediumValues[mediumValues.length - 1].value} <span class="text-base font-normal">(${mediumValues[mediumValues.length - 1].name})</span></span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-sm text-blue-700">Average Median:</span>
                                <span class="font-bold text-lg">${(() => {
                                    const total = mediumValues.reduce((sum, item) => sum + parseFloat(item.value.replace(/[^0-9.]/g, '')), 0);
                                    const average = total / mediumValues.length;
                                    return `$${(average / 1000).toFixed(0)}K`; // Format as $X.XK
                                })()}</span>
                            </div>
                        `;

                        estimatedValuesSummary.innerHTML = summaryContentHtml;
                        estimatedValuesSummary.style.display = 'flex';
                    }

                    if (pvDataFound) {
                        summaryDataContainer.style.display = 'flex';
                    }

                    if (anyLinkGenerated || mediumValues.length > 0 || pvDataFound) { 
                        resultsSection.style.display = 'block';
                    }

                    if (!anyLinkGenerated && !pvDataFound && mediumValues.length === 0) {
                        errorMessage.textContent = 'No property links, summary data, or estimated values could be generated for the given address from any site.';
                         introductoryText.style.display = 'block'; 
                    }

                } catch (error) {
                    console.error('Overall error during link generation:', error);
                    errorMessage.textContent = error.message || 'An unexpected overall error occurred during link generation.';
                     introductoryText.style.display = 'block'; 
                } finally {
                    loadingSpinner.style.display = 'none';
                    // We explicitly control button state based on autocomplete selection now
                    // searchButton.disabled = false; 
                }
            });
        });
    </script>
</body>
</html>
