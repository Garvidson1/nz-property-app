<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NZ Property Value Finder</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/styles/main.css">

    </head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-8">Find Your Property Values</h1>

        <div class="flex items-center w-full mb-8">
            <input type="text" id="addressInput" placeholder="Enter an address..." class="flex-grow border border-gray-300 py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="searchButton" class="bg-gray-800 text-white px-6 py-2 font-semibold hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <span class="long-text">Find property values</span>
                <span class="short-text">Find</span>
            </button>
        </div>

        <div class="loading-spinner hidden">
            <div class="double-bounce1"></div>
            <div class="double-bounce2"></div>
        </div>

        <div id="errorMessage" class="text-red-600 text-center mb-4"></div>

        <div id="summaryDataContainer" class="hidden bg-gray-100 p-4 rounded-lg shadow-md mb-8 flex flex-col md:flex-row justify-around items-center text-center">
            <div class="mb-4 md:mb-0">
                <p class="text-sm text-gray-500">Capital Value</p>
                <p id="capitalValue" class="text-lg font-semibold text-gray-800">N/A</p>
            </div>
            <div class="mb-4 md:mb-0">
                <p class="text-sm text-gray-500">Land Value</p>
                <p id="landValue" class="text-lg font-semibold text-gray-800">N/A</p>
            </div>
            <div class="mb-4 md:mb-0">
                <p class="text-sm text-gray-500">Improvement Value</p>
                <p id="improvementValue" class="text-lg font-semibold text-gray-800">N/A</p>
            </div>
            <div class="mb-4 md:mb-0">
                <p class="text-sm text-gray-500">Valuation Date</p>
                <p id="valuationDate" class="text-lg font-semibold text-gray-800">N/A</p>
            </div>
            <div>
                <p class="text-sm text-gray-500">Estimated Rate of Return</p>
                <p id="rateOfReturn" class="text-lg font-semibold text-gray-800">N/A</p>
            </div>
        </div>

        <div id="propertyPhotoContainer" class="hidden mb-8 text-center">
            <p class="text-sm text-gray-500 mb-2">Primary Property Photo</p>
            <img id="propertyPhoto" src="" alt="Property Photo" class="max-w-full h-auto mx-auto rounded-lg shadow-md">
        </div>

        <div id="resultsSection" class="hidden mt-8">
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200 rounded-2xl overflow-hidden">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Link</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Estimated Value (Low)</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Estimated Value (Medium)</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Estimated Value (High)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr id="homesRow">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Homes.co.nz</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><a href="#" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hidden">View</a></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center" data-value="low">N/A</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold text-center" data-value="medium">N/A</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center" data-value="high">N/A</td>
                        </tr>
                        <tr id="oneroofRow">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">OneRoof.co.nz</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><a href="#" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hidden">View</a></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center" data-value="low">N/A</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold text-center" data-value="medium">N/A</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center" data-value="high">N/A</td>
                        </tr>
                        <tr id="propertyValueRow">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">PropertyValue.co.nz</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><a href="#" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hidden">View</a></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center" colspan="3">
                                <span class="text-gray-500">Summary data available above.</span>
                            </td>
                        </tr>
                        <tr id="qvRow">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">QV.co.nz</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><a href="#" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hidden">View</a></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center" colspan="3">
                                <span class="text-gray-500">Values not scraped from this site.</span>
                            </td>
                        </tr>
                        <tr id="realEstateRow">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">RealEstate.co.nz</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><a href="#" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hidden">View</a></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center" colspan="3">
                                <span class="text-gray-500">Values not scraped from this site.</span>
                            </td>
                        </tr>
                        <tr id="tradeMeRow">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">TradeMe.co.nz</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><a href="#" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hidden">View</a></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center" colspan="3">
                                <span class="text-gray-500">Values not scraped from this site.</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const addressInput = document.getElementById('addressInput');
            const searchButton = document.getElementById('searchButton');
            const loadingSpinner = document.querySelector('.loading-spinner');
            const errorMessage = document.getElementById('errorMessage');
            const resultsSection = document.getElementById('resultsSection');
            const summaryDataContainer = document.getElementById('summaryDataContainer');
            const propertyPhotoContainer = document.getElementById('propertyPhotoContainer');
            const propertyPhoto = document.getElementById('propertyPhoto');
            const capitalValueCell = document.getElementById('capitalValue');
            const landValueCell = document.getElementById('landValue');
            const improvementValueCell = document.getElementById('improvementValue');
            const valuationDateCell = document.getElementById('valuationDate');
            const rateOfReturnCell = document.getElementById('rateOfReturn');


            const siteRows = {
                homes: document.getElementById('homesRow'),
                oneroof: document.getElementById('oneroofRow'),
                propertyvalue: document.getElementById('propertyValueRow'),
                qv: document.getElementById('qvRow'),
                realestate: document.getElementById('realEstateRow'),
                trademe: document.getElementById('tradeMeRow')
            };

            const getLinkCell = (row) => row.querySelector('td:nth-child(2) a');
            const getEstimatedValueCell = (row, type) => row.querySelector(`td[data-value="${type}"]`);


            // Adjust input width on small screens for better UX
            const adjustInputWidth = () => {
                if (window.innerWidth < 640) { // Tailwind's 'sm' breakpoint is 640px
                    addressInput.classList.remove('flex-grow');
                    addressInput.classList.add('w-full');
                    searchButton.querySelector('.long-text').classList.add('hidden');
                    searchButton.querySelector('.short-text').classList.remove('hidden');
                } else {
                    addressInput.classList.add('flex-grow');
                    addressInput.classList.remove('w-full');
                    searchButton.querySelector('.long-text').classList.remove('hidden');
                    searchButton.querySelector('.short-text').classList.add('hidden');
                }
            };

            adjustInputWidth(); // Call on load
            window.addEventListener('resize', adjustInputWidth); // Call on resize


            searchButton.addEventListener('click', async () => {
                const address = addressInput.value.trim();
                errorMessage.textContent = '';
                resultsSection.style.display = 'none';
                summaryDataContainer.style.display = 'none';
                propertyPhotoContainer.style.display = 'none';
                propertyPhoto.src = ''; // Clear previous photo

                // Reset all rows to their initial state (N/A and hidden links)
                Object.values(siteRows).forEach(row => {
                    const linkCell = getLinkCell(row);
                    if (linkCell) {
                        linkCell.href = '#';
                        linkCell.classList.add('hidden');
                    }
                    // Reset estimated values if they exist for the row
                    const lowCell = getEstimatedValueCell(row, 'low');
                    const mediumCell = getEstimatedValueCell(row, 'medium');
                    const highCell = getEstimatedValueCell(row, 'high');
                    if (lowCell) lowCell.textContent = 'N/A';
                    if (mediumCell) mediumCell.textContent = 'N/A';
                    if (highCell) highCell.textContent = 'N/A';
                });

                // Reset summary data
                capitalValueCell.textContent = 'N/A';
                landValueCell.textContent = 'N/A';
                improvementValueCell.textContent = 'N/A';
                valuationDateCell.textContent = 'N/A';
                rateOfReturnCell.innerHTML = 'N/A'; // Use innerHTML for rate of return


                if (!address) {
                    errorMessage.textContent = 'Please enter an address.';
                    return;
                }

                loadingSpinner.style.display = 'block';
                searchButton.disabled = true;

                try {
                    const endpoints = {
                        homes: '/api/get-homes-url',
                        oneroof: '/api/get-oneroof-url',
                        propertyvalue: '/api/get-propertyvalue-url', // This now handles scraping
                        qv: '/api/get-qv-url',
                        realestate: '/api/get-realestate-url',
                        trademe: '/api/get-trademe-url'
                    };

                    const scrapeEndpoints = {
                        homes: '/api/scrape-homes-values',
                        oneroof: '/api/scrape-oneroof-values'
                    };

                    let anyLinkGenerated = false;
                    let pvDataFound = false;
                    let mediumValues = []; // To store medium values for averaging

                    const processSite = async (site, endpoint, rowElement) => {
                        try {
                            const response = await fetch(endpoint, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ address })
                            });

                            const data = await response.json();
                            const linkCell = getLinkCell(rowElement);

                            if (response.ok && data.url) {
                                linkCell.href = data.url;
                                linkCell.classList.remove('hidden');
                                anyLinkGenerated = true;

                                // If PropertyValue, handle scraped data
                                if (site === 'propertyvalue' && data.data) {
                                    pvDataFound = true;
                                    // Store pvData globally or pass it if needed for rateOfReturn
                                    // For now, let's assume `data.data.lastSold` is accessible here or re-fetch.
                                    // If you want to use it outside this scope, declare pvData as a global variable.
                                    // For simplicity in this example, I'll access it directly if processSite handles it all.
                                    capitalValueCell.textContent = data.data.capitalValue || 'N/A';
                                    landValueCell.textContent = data.data.landValue || 'N/A';
                                    improvementValueCell.textContent = data.data.improvementValue || 'N/A';
                                    valuationDateCell.textContent = data.data.valuationDate || 'N/A';

                                    if (data.data.propertyPhotoSrc && data.data.propertyPhotoSrc !== 'N/A') {
                                        propertyPhoto.src = data.data.propertyPhotoSrc;
                                        propertyPhotoContainer.style.display = 'block';
                                    } else {
                                        propertyPhotoContainer.style.display = 'none'; // Hide if no photo
                                    }

                                    // Handle Rate of Return here directly since we have pvData.data
                                    let rateOfReturnHtml = '';
                                    const lastSoldDataString = data.data.lastSold; // Directly use data.data
                                    const capitalValueString = capitalValueCell.textContent;

                                    const parseCurrency = (str) => {
                                        if (!str || typeof str !== 'string') return NaN;
                                        return parseFloat(str.replace(/[^0-9.-]+/g,""));
                                    };

                                    const lastSoldPrice = parseCurrency(lastSoldDataString);
                                    const capitalValue = parseCurrency(capitalValueString);

                                    if (!isNaN(lastSoldPrice) && !isNaN(capitalValue) && lastSoldPrice > 0) {
                                        const rateOfReturn = ((capitalValue - lastSoldPrice) / lastSoldPrice) * 100;
                                        rateOfReturnHtml = `${rateOfReturn.toFixed(2)}%<span class="text-xs font-normal text-gray-500 block">based on last sold price of ${lastSoldDataString}</span>`;
                                    } else if (lastSoldDataString && lastSoldDataString !== 'N/A') {
                                        rateOfReturnHtml = 'N/A<span class="text-xs font-normal text-gray-500 block">Last sold data malformed</span>';
                                    } else {
                                        rateOfReturnHtml = 'N/A<span class="text-xs font-normal text-gray-500 block">Last sold data missing</span>';
                                    }
                                    rateOfReturnCell.innerHTML = rateOfReturnHtml;

                                }


                                // If Homes or OneRoof, trigger scraping for estimated values
                                if (scrapeEndpoints[site]) {
                                    const scrapeResponse = await fetch(scrapeEndpoints[site], {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ url: data.url })
                                    });
                                    const scrapeData = await scrapeResponse.json();

                                    if (scrapeResponse.ok && scrapeData.estimatedValues) {
                                        const lowCell = getEstimatedValueCell(rowElement, 'low');
                                        const mediumCell = getEstimatedValueCell(rowElement, 'medium');
                                        const highCell = getEstimatedValueCell(rowElement, 'high');

                                        if (lowCell) lowCell.textContent = scrapeData.estimatedValues.low !== 'N/A' ? scrapeData.estimatedValues.low : 'N/A';
                                        if (mediumCell) {
                                            mediumCell.textContent = scrapeData.estimatedValues.medium !== 'N/A' ? scrapeData.estimatedValues.medium : 'N/A';
                                            // Add to medium values for average if valid number
                                            const numericMedium = parseFloat(scrapeData.estimatedValues.medium.replace(/[^0-9.-]+/g,""));
                                            if (!isNaN(numericMedium)) {
                                                mediumValues.push(numericMedium);
                                            }
                                        }
                                        if (highCell) highCell.textContent = scrapeData.estimatedValues.high !== 'N/A' ? scrapeData.estimatedValues.high : 'N/A';
                                    } else {
                                        console.warn(`Scraping for ${site} failed:`, scrapeData.error || 'Unknown error');
                                    }
                                }
                            } else {
                                console.warn(`${site} link generation failed:`, data.error || 'Unknown error');
                                if (linkCell) linkCell.classList.add('hidden'); // Ensure link is hidden on error
                            }
                        } catch (error) {
                            console.error(`Error processing ${site}:`, error);
                            const linkCell = getLinkCell(rowElement);
                            if (linkCell) linkCell.classList.add('hidden'); // Ensure link is hidden on error
                        }
                    };

                    await Promise.all([
                        processSite('homes', endpoints.homes, siteRows.homes),
                        processSite('oneroof', endpoints.oneroof, siteRows.oneroof),
                        processSite('propertyvalue', endpoints.propertyvalue, siteRows.propertyvalue),
                        processSite('qv', endpoints.qv, siteRows.qv),
                        processSite('realestate', endpoints.realestate, siteRows.realestate),
                        processSite('trademe', endpoints.trademe, siteRows.trademe)
                    ]);

                    // Calculate and display average medium value (if needed, this was from previous iterations)
                    // If you still want an overall average of Homes and OneRoof, this logic is fine.
                    // If not, you can remove this block.
                    if (mediumValues.length > 0) {
                        const averageMedium = mediumValues.reduce((sum, val) => sum + val, 0) / mediumValues.length;
                        // You might need a specific element for this average, currently not present in the HTML.
                        // Example: document.getElementById('averageValue').textContent = `Average Estimated Value: $${averageMedium.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                    }


                    if (pvDataFound) {
                        summaryDataContainer.style.display = 'flex';
                    }

                    if (anyLinkGenerated || mediumValues.length > 0) {
                        resultsSection.style.display = 'block';
                    }

                    if (!anyLinkGenerated && !pvDataFound && mediumValues.length === 0) {
                        errorMessage.textContent = 'No property links, summary data, or estimated values could be generated for the given address from any site.';
                    }

                } catch (error) {
                    console.error('Overall error during link generation:', error);
                    errorMessage.textContent = error.message || 'An unexpected overall error occurred during link generation.';
                } finally {
                    loadingSpinner.style.display = 'none';
                    searchButton.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
