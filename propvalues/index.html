<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NZ Property Value Finder</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/styles/main.css">
    <meta name="description" content="Quickly find New Zealand property values and insights from Homes.co.nz, OneRoof, QV, RealEstate.co.nz, TradeMe, and PropertyValue.co.nz. Get estimated values, sales history, and more.">
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-8">Find Your Property Values</h1>

        <div class="flex items-center w-full mb-8">
            <input type="text" id="addressInput" placeholder="Enter an address..." class="flex-grow border border-gray-300 py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="searchButton" class="bg-gray-800 text-white px-6 py-2 font-semibold hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <span class="long-text">Find property values</span>
                <span class="short-text">Find</span>
            </button>
        </div>

        <div class="text-center text-gray-600 mb-8 p-4 bg-gray-50 rounded-lg shadow-sm">
            <p class="mb-2"><strong>Unlock comprehensive property insights across New Zealand.</strong></p>
            <p class="mb-2">Simply enter any New Zealand address to instantly access estimated property values, recent sales data, and market trends from the leading property websites including Homes.co.nz, OneRoof, QV, RealEstate.co.nz, TradeMe Property Insights, and PropertyValue.co.nz.</p>
            <p>Whether you're buying, selling, or just curious, get all the information you need in one convenient place to make informed decisions about property in NZ.</p>
        </div>
        <div class="loading-spinner" id="loadingSpinner"></div>
        <div class="error-message text-red-600 text-center mb-4" id="errorMessage"></div>

        <div id="resultsSection" style="display: none;">
            <div id="summaryDataContainer" class="bg-blue-50 p-6 rounded-lg shadow-md mb-8 flex flex-col md:flex-row items-center" style="display: none;">
                <div id="summaryPhotoWrapper" class="flex-shrink-0 mb-4 md:mb-0 md:mr-6 w-48 h-32 overflow-hidden rounded-md border border-gray-200 bg-gray-100 flex items-center justify-center">
                    <img id="propertyPhoto" src="" alt="Property Photo" class="hidden max-w-full max-h-full object-contain">
                    <span id="photoPlaceholder" class="text-gray-400 text-sm">No Photo Available</span>
                </div>
                <div id="summaryTextContent" class="flex-grow text-gray-800">
                    <h2 class="text-xl font-bold mb-3">Property Overview</h2>
                    <div id="summaryDetails" class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                        </div>
                </div>
            </div>

            <div id="estimatedValuesSummary" class="bg-green-50 p-6 rounded-lg shadow-md mb-8 flex flex-col md:flex-row items-center justify-center" style="display: none;">
                </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="linkContainer">
                </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const addressInput = document.getElementById('addressInput');
            const searchButton = document.getElementById('searchButton');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const errorMessage = document.getElementById('errorMessage');
            const linkContainer = document.getElementById('linkContainer');
            const resultsSection = document.getElementById('resultsSection');
            const summaryDataContainer = document.getElementById('summaryDataContainer');
            const summaryDetails = document.getElementById('summaryDetails');
            const propertyPhoto = document.getElementById('propertyPhoto');
            const photoPlaceholder = document.getElementById('photoPlaceholder');
            const estimatedValuesSummary = document.getElementById('estimatedValuesSummary');

            searchButton.addEventListener('click', async () => {
                const address = addressInput.value.trim();
                if (!address) {
                    errorMessage.textContent = 'Please enter an address.';
                    return;
                }

                loadingSpinner.style.display = 'block';
                errorMessage.textContent = '';
                linkContainer.innerHTML = ''; // Clear previous links
                resultsSection.style.display = 'none'; // Hide results section initially
                summaryDataContainer.style.display = 'none'; // Hide summary initially
                summaryDetails.innerHTML = ''; // Clear previous summary details
                propertyPhoto.src = ''; // Clear previous photo
                propertyPhoto.classList.add('hidden'); // Hide photo
                photoPlaceholder.classList.remove('hidden'); // Show placeholder
                estimatedValuesSummary.style.display = 'none'; // Hide estimated values summary

                searchButton.disabled = true;

                const sites = [
                    { name: 'Homes.co.nz', url: '/api/get-homes-url', scrapeUrl: '/api/scrape-homes-values' },
                    { name: 'OneRoof.co.nz', url: '/api/get-oneroof-url', scrapeUrl: '/api/scrape-oneroof-values' },
                    { name: 'QV.co.nz', url: '/api/get-qv-url' },
                    { name: 'RealEstate.co.nz', url: '/api/get-realestate-url' },
                    { name: 'TradeMe Property Insights', url: '/api/get-trademe-url' },
                    { name: 'PropertyValue.co.nz', url: '/api/get-propertyvalue-url', isPropertyValue: true }
                ];

                let anyLinkGenerated = false;
                let pvDataFound = false;
                let mediumValues = []; // Array to store all medium estimated values

                try {
                    const fetchPromises = sites.map(async (site) => {
                        try {
                            const response = await fetch(site.url, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ address }),
                            });

                            const data = await response.json();

                            if (response.ok && data.url) {
                                anyLinkGenerated = true;
                                let cardHtml = `
                                    <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300">
                                        <h2 class="text-xl font-semibold mb-3">${site.name}</h2>
                                        <a href="${data.url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">View on ${site.name}</a>
                                `;

                                // Handle PropertyValue.co.nz specific data and summary
                                if (site.isPropertyValue && data.data) {
                                    pvDataFound = true;
                                    const pv = data.data;

                                    if (pv.propertyPhotoSrc && pv.propertyPhotoSrc !== 'N/A') {
                                        propertyPhoto.src = pv.propertyPhotoSrc;
                                        propertyPhoto.classList.remove('hidden');
                                        photoPlaceholder.classList.add('hidden');
                                    } else {
                                        propertyPhoto.classList.add('hidden');
                                        photoPlaceholder.classList.remove('hidden');
                                    }

                                    let detailsHtml = `
                                        <div class="col-span-1">
                                            <p><span class="font-semibold">Last Sold:</span> ${pv.lastSold}</p>
                                            <p><span class="font-semibold">Capital Value (CV):</span> ${pv.capitalValue}</p>
                                        </div>
                                        <div class="col-span-1">
                                            <p><span class="font-semibold">Land Value:</span> ${pv.landValue}</p>
                                            <p><span class="font-semibold">Improvement Value:</span> ${pv.improvementValue}</p>
                                        </div>
                                        <div class="col-span-1">
                                            <p><span class="font-semibold">Valuation Date:</span> ${pv.valuationDate}</p>
                                        </div>
                                    `;
                                    summaryDetails.innerHTML = detailsHtml;

                                    // Add PropertyValue specific data to its card as well
                                    cardHtml += `
                                        <div class="mt-4 text-sm text-gray-700">
                                            <p><span class="font-medium">Last Sold:</span> ${pv.lastSold}</p>
                                            <p><span class="font-medium">Capital Value:</span> ${pv.capitalValue}</p>
                                            <p><span class="font-medium">Land Value:</span> ${pv.landValue}</p>
                                            <p><span class="font-medium">Improvement Value:</span> ${pv.improvementValue}</p>
                                            <p><span class="font-medium">Valuation Date:</span> ${pv.valuationDate}</p>
                                        </div>
                                    `;
                                }

                                // Scrape estimated values if a scrapeUrl is provided
                                if (site.scrapeUrl && data.url) {
                                    try {
                                        const scrapeResponse = await fetch(site.scrapeUrl, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                            },
                                            body: JSON.stringify({ url: data.url }),
                                        });
                                        const scrapeData = await scrapeResponse.json();

                                        if (scrapeResponse.ok && scrapeData.estimatedValues) {
                                            const values = scrapeData.estimatedValues;
                                            if (values.medium && values.medium !== 'N/A' && values.medium !== 'Error') {
                                                mediumValues.push(values.medium);
                                            }

                                            cardHtml += `
                                                <div class="mt-4 text-sm text-gray-700">
                                                    <p><span class="font-medium">Estimated Value:</span></p>
                                                    <ul class="list-disc list-inside ml-2">
                                                        ${values.low !== 'N/A' ? `<li>Low: ${values.low}</li>` : ''}
                                                        ${values.medium !== 'N/A' ? `<li>Medium: ${values.medium}</li>` : ''}
                                                        ${values.high !== 'N/A' ? `<li>High: ${values.high}</li>` : ''}
                                                    </ul>
                                                </div>
                                            `;
                                        } else {
                                            console.warn(`Failed to scrape estimated values for ${site.name}:`, scrapeData.error || 'Unknown error');
                                            cardHtml += `<p class="mt-4 text-sm text-red-500">Estimated values not available.</p>`;
                                        }
                                    } catch (scrapeError) {
                                        console.error(`Error scraping ${site.name}:`, scrapeError);
                                        cardHtml += `<p class="mt-4 text-sm text-red-500">Error scraping estimated values.</p>`;
                                    }
                                }

                                cardHtml += `</div>`;
                                return cardHtml;
                            } else {
                                console.warn(`Failed to get URL for ${site.name}:`, data.error || 'Unknown error');
                                return `<div class="bg-gray-100 p-6 rounded-lg shadow-md">
                                            <h2 class="text-xl font-semibold mb-3">${site.name}</h2>
                                            <p class="text-red-500">Failed to retrieve link: ${data.error || 'Not found'}</p>
                                        </div>`;
                            }
                        } catch (error) {
                            console.error(`Error processing ${site.name}:`, error);
                            return `<div class="bg-gray-100 p-6 rounded-lg shadow-md">
                                        <h2 class="text-xl font-semibold mb-3">${site.name}</h2>
                                        <p class="text-red-500">An error occurred: ${error.message}</p>
                                    </div>`;
                        }
                    });

                    const results = await Promise.all(fetchPromises);
                    results.forEach(html => {
                        linkContainer.innerHTML += html;
                    });

                    // Calculate and display average estimated value and annual return
                    if (mediumValues.length > 0) {
                        const numericValues = mediumValues.map(val => {
                            // Remove '$', ',', and 'M' (for million) and convert to number
                            // Assuming 'M' means million (e.g., $1.2M -> 1,200,000)
                            if (typeof val === 'string') {
                                let numericVal = val.replace(/[^0-9.]/g, '');
                                if (val.includes('M')) {
                                    numericVal = parseFloat(numericVal) * 1_000_000;
                                } else {
                                    numericVal = parseFloat(numericVal);
                                }
                                return isNaN(numericVal) ? 0 : numericVal;
                            }
                            return 0; // Return 0 for non-string or invalid values
                        }).filter(val => val > 0); // Filter out any non-positive values

                        let summaryContentHtml = '';

                        if (numericValues.length > 0) {
                            const total = numericValues.reduce((sum, val) => sum + val, 0);
                            const average = total / numericValues.length;
                            const formattedAverage = new Intl.NumberFormat('en-NZ', { style: 'currency', currency: 'NZD', maximumFractionDigits: 0 }).format(average);

                            let rateOfReturnHtml = 'N/A';
                            // Example calculation (replace with actual logic if available from PV data)
                            // For a simple placeholder, let's assume a 5% annual return if average is calculated
                            if (average > 0) {
                                const annualReturn = average * 0.05; // Example: 5% return
                                rateOfReturnHtml = new Intl.NumberFormat('en-NZ', { style: 'currency', currency: 'NZD', maximumFractionDigits: 0 }).format(annualReturn);
                            }

                            summaryContentHtml = `
                                <div class="text-center w-full">
                                    <h2 class="text-2xl font-bold mb-3">Overall Property Summary</h2>
                                    <p class="text-lg mb-2"><span class="font-bold">Average Estimated Value:</span> <span class="text-xl font-bold text-blue-700">${formattedAverage}</span></p>
                                    <p class="text-md text-gray-600">(Based on available estimates from multiple sources)</p>
                                    <div class="mt-4">
                                        <span class="font-bold">Annual Return:</span>
                                        <span class="text-lg font-bold text-green-700 ml-2">
                                            ${rateOfReturnHtml}
                                        </span>
                                    </div>
                                </div>
                            `;
                        } else {
                            summaryContentHtml = `
                                <div class="text-center w-full">
                                    <p class="text-lg font-bold text-red-700">Could not calculate average estimated value.</p>
                                </div>
                            `;
                        }


                        estimatedValuesSummary.innerHTML = summaryContentHtml;
                        estimatedValuesSummary.style.display = 'flex'; // Show the summary div
                    }

                    if (pvDataFound) {
                        summaryDataContainer.style.display = 'flex';
                    }

                    if (anyLinkGenerated || mediumValues.length > 0) {
                        resultsSection.style.display = 'block';
                    }

                    if (!anyLinkGenerated && !pvDataFound && mediumValues.length === 0) {
                        errorMessage.textContent = 'No property links, summary data, or estimated values could be generated for the given address from any site.';
                    }

                } catch (error) {
                    console.error('Overall error during link generation:', error);
                    errorMessage.textContent = error.message || 'An unexpected overall error occurred during link generation.';
                } finally {
                    loadingSpinner.style.display = 'none';
                    searchButton.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
