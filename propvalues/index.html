<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NZ Property Value Finder</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/styles/main.css">
    <meta name="description" content="Quickly find New Zealand property values and insights from Homes.co.nz, OneRoof, QV, RealEstate.co.nz, TradeMe, and PropertyValue.co.nz. Get estimated values, sales history, and more.">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0910314329433856"
          crossorigin="anonymous"></script>
</head>
<body>
    <header class="site-header">
        <div class="header-content-wrapper">
            <h1 class="header-title">Find Your Property Values</h1>
            <div class="header-search-wrapper">
                <input type="text" id="addressInput" placeholder="Enter an address..." class="flex-grow py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="searchButton" class="font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <span class="long-text">Find property values</span>
                    <span class="short-text">Find</span>
                </button>
            </div>
        </div>
    </header>

    <div class="xx">
        <div id="introductoryText" class="container">
            <p class="mb-2"><strong>Unlock comprehensive property insights across New Zealand.</strong></p>
            <p class="mb-2">Simply enter any New Zealand address to instantly access estimated property values, recent sales data, and market trends from the leading property websites including Homes.co.nz, OneRoof, QV, RealEstate.co.nz, TradeMe Property Insights, and PropertyValue.co.nz.</p>
            <p>Whether you're buying, selling, or just curious, get all the information you need in one convenient place to make informed decisions about property in NZ.</p>
        </div>

        <div class="loading-spinner" id="loadingSpinner"></div>
        <p class="error-message" id="errorMessage"></p>

        <div id="summaryData" class="container">
            <div id="summaryPhotoWrapper"></div>
            <div id="summaryTextContent"></div>
        </div>

        <div id="results">
            <div class="container">
            <h2 class="mt-8">Estimated Values:</h2>
            <div class="overflow-x-auto">
                <table id="estimatedValuesTable" class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr class="bg-gray-100 text-left text-sm text-gray-600 uppercase tracking-wider">
                            <th class="py-3 px-4 border-b border-gray-200">Source</th>
                            <th class="py-3 px-4 border-b border-gray-200">Low</th>
                            <th class="py-3 px-4 border-b border-gray-200">Medium</th>
                            <th class="py-3 px-4 border-b border-gray-200">High</th>
                        </tr>
                    </thead>
                    <tbody id="estimatedValuesTableBody">
                    </tbody>
                </table>
            </div>
            <div id="estimatedValuesSummary" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg flex justify-between items-center text-gray-800">
            </div></div>
            <div class="container">
                <h2>Property Page Links</h2>
            <ul id="urlList">
            </ul>
               </div>  
        </div>
    </div>

    <div class="disclaimer-text">
        Disclaimer: While we've done our best to correctly find property pages for an address, it may not be exact. Please review property links for accuracy. Some addresses will not be matched exactly because of unit numbers etc.
    </div>

    <script>
        let autocomplete;

        function initAutocomplete() {
            const addressInput = document.getElementById('addressInput');
            if (addressInput) {
                autocomplete = new google.maps.places.Autocomplete(addressInput, {
                    types: ['address'],
                    componentRestrictions: { 'country': ['nz'] }
                });
                autocomplete.addListener('place_changed', onPlaceChanged);
            } else {
                console.error("Address input element not found. Autocomplete could not be initialized.");
            }
        }

        function onPlaceChanged() {
            const place = autocomplete.getPlace();
            const addressInput = document.getElementById('addressInput');
            const errorMessage = document.getElementById('errorMessage');

            if (!place || !place.address_components || !place.geometry) {
                console.warn("No valid place details available for input: '" + (place && place.name ? place.name : addressInput.value) + "'");
                return;
            }

            let subpremise = '';
            let streetNumber = '';
            let route = '';
            let currentSublocality = '';
            let currentLocality = '';

            for (let i = 0; i < place.address_components.length; i++) {
                const component = place.address_components[i];
                const types = component.types; 

                if (types.includes('subpremise')) {
                    subpremise = component.long_name;
                } else if (types.includes('street_number')) {
                    streetNumber = component.long_name;
                } else if (types.includes('route')) {
                    route = component.long_name;
                } else if (types.includes('sublocality_level_1') || types.includes('sublocality')) {
                    currentSublocality = component.long_name; 
                } else if (types.includes('locality')) {
                    currentLocality = component.long_name;
                }
            }
            
            let addressParts = [];
            let streetAddressPart = '';

            if (route) { 
                if (subpremise && streetNumber) {
                    streetAddressPart = `${subpremise}/${streetNumber} ${route}`;
                } else if (streetNumber) {
                    streetAddressPart = `${streetNumber} ${route}`;
                } else if (subpremise) {
                    streetAddressPart = `${subpremise} ${route}`;
                } else { 
                    streetAddressPart = route;
                }
                addressParts.push(streetAddressPart);
            }

            if (currentSublocality) {
                addressParts.push(currentSublocality);
            } else if (currentLocality && streetAddressPart) { 
                addressParts.push(currentLocality);
            }

            const desiredAddress = addressParts.join(', ');

            if (desiredAddress) {
                addressInput.value = desiredAddress;
                if (errorMessage) errorMessage.textContent = '';
            } else {
                let fallbackValue = place.formatted_address || place.name || "";
                addressInput.value = fallbackValue;
                if (errorMessage) {
                    if (fallbackValue) {
                        errorMessage.textContent = "Could not parse specific address components, using full address.";
                    } else {
                        errorMessage.textContent = "Address details could not be retrieved.";
                    }
                }
                console.warn("Failed to parse desired address components. Using fallback:", fallbackValue);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const addressInput = document.getElementById('addressInput');
            const searchButton = document.getElementById('searchButton');
            const urlList = document.getElementById('urlList');
            const errorMessage = document.getElementById('errorMessage');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const summaryDataContainer = document.getElementById('summaryData');
            const summaryPhotoWrapper = document.getElementById('summaryPhotoWrapper');
            const summaryTextContent = document.getElementById('summaryTextContent');
            const resultsSection = document.getElementById('results');
            const estimatedValuesTableBody = document.getElementById('estimatedValuesTableBody');
            const estimatedValuesSummary = document.getElementById('estimatedValuesSummary');
            const introductoryText = document.getElementById('introductoryText');

            // New function to format currency
            function formatCurrencyAbbreviated(value) {
                if (isNaN(value)) {
                    return value;
                }
                
                if (value >= 1000000) {
                    // Format to 'M' (Millions) with up to 2 decimal places if needed
                    return '$' + (value / 1000000).toFixed(2).replace(/\.00$/, '') + 'M';
                } else if (value >= 1000) {
                    // Format to 'K' (Thousands) with no decimal places, unless needed for 3 digits
                    let kValue = (value / 1000);
                    if (kValue % 1 !== 0 && kValue < 100) { // If it has decimals and is less than 100K, keep one decimal
                        return '$' + kValue.toFixed(1) + 'K';
                    }
                    return '$' + kValue.toFixed(0) + 'K';
                } else {
                    return '$' + value.toFixed(0); // For values less than 1K, just show the number
                }
            }

            function parseCurrencyToNumber(currencyString) {
                if (!currencyString || typeof currencyString !== 'string') {
                    return NaN;
                }
                let cleanedString = currencyString.replace(/[\$,]/g, '').trim();
                let numericValue = parseFloat(cleanedString);
                if (cleanedString.endsWith('M')) {
                    numericValue *= 1000000;
                } else if (cleanedString.endsWith('K')) {
                    numericValue *= 1000;
                }
                return numericValue;
            }

            async function loadGoogleMapsScript() {
                try {
                    const response = await fetch('/api/get-google-maps-key');
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Failed to fetch API key: ${response.statusText}`);
                    }
                    const data = await response.json();
                    const googleMapsApiKey = data.apiKey;

                    if (!googleMapsApiKey) {
                        throw new Error('API key not returned by server.');
                    }

                    const googleMapsScript = document.createElement('script');
                    googleMapsScript.src = `https://maps.googleapis.com/maps/api/js?key=${googleMapsApiKey}&libraries=places&callback=initAutocomplete`;
                    googleMapsScript.async = true;
                    googleMapsScript.defer = true; 
                    document.head.appendChild(googleMapsScript);

                } catch (error) {
                    console.error("Error loading Google Maps API script:", error);
                    if(errorMessage) errorMessage.textContent = "Error initializing maps: " + error.message;
                    if (addressInput) addressInput.disabled = true;
                    if (searchButton) searchButton.disabled = true;
                }
            }
            
            loadGoogleMapsScript();

            function addLinkToUI(siteName, urlOrError, isError = false, scrapedData = null) {
                const listItem = document.createElement('li');
                const nameSpan = document.createElement('span');
                nameSpan.className = 'site-name';
                nameSpan.textContent = siteName;
                listItem.appendChild(nameSpan);

                if (isError) {
                    const textSpan = document.createElement('span');
                    textSpan.className = 'no-link';
                    textSpan.classList.add('error-text-small'); 
                    textSpan.textContent = urlOrError;
                    listItem.appendChild(textSpan);
                } else {
                    const link = document.createElement('a');
                    link.href = urlOrError;
                    link.textContent = urlOrError;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    listItem.appendChild(link);

                    if (scrapedData && Object.keys(scrapedData).length > 0 && !scrapedData.estimatedValues) {
                        const dataDiv = document.createElement('div');
                        dataDiv.className = 'scraped-data';
                        let dataText = '';
                        dataDiv.innerHTML = dataText.trim().replace(/\n/g, '<br>');
                        if (dataText.trim()) {
                            listItem.appendChild(dataDiv);
                        }
                    }
                }
                urlList.appendChild(listItem);
            }

            let lowValuesForBolding = [];
            let highValuesForBolding = [];

            function displayEstimatedValues(siteName, url, estimatedValues, urlError = null) {
                const row = estimatedValuesTableBody.insertRow();
                row.className = 'text-sm text-gray-800';

                const websiteCell = row.insertCell();
                if (url && url !== 'N/A' && url !== 'No direct link found.' && !url.includes("Error")) {
                    const link = document.createElement('a');
                    link.href = url;
                    link.textContent = siteName;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    link.className = 'text-blue-700 hover:underline font-medium';
                    websiteCell.appendChild(link);

                    if (urlError) {
                        const errorSpan = document.createElement('span');
                        errorSpan.classList.add('error-text-small'); 
                        errorSpan.textContent = ` (${urlError})`;
                        websiteCell.appendChild(errorSpan);
                    }

                } else {
                    websiteCell.textContent = siteName;
                    if (urlError) {
                        const errorSpan = document.createElement('span');
                        errorSpan.classList.add('error-text-small'); 
                        errorSpan.textContent = ` (${urlError})`;
                        websiteCell.appendChild(errorSpan);
                    } else if (url && url.includes("Error")) {
                        const errorSpan = document.createElement('span');
                        errorSpan.classList.add('error-text-small'); 
                        errorSpan.textContent = ` (Error retrieving URL)`;
                        websiteCell.appendChild(errorSpan);
                    }
                }
                websiteCell.className += ' py-2 px-4 border-b border-gray-200';

                const lowCell = row.insertCell();
                const lowValue = estimatedValues.low || 'N/A';
                // Apply abbreviation if the value is a number
                lowCell.textContent = isNaN(parseCurrencyToNumber(lowValue)) ? lowValue : formatCurrencyAbbreviated(parseCurrencyToNumber(lowValue));
                lowCell.className = 'py-2 px-4 border-b border-gray-200';
                const numericLow = parseCurrencyToNumber(lowValue);
                if (!isNaN(numericLow)) {
                    lowValuesForBolding.push({ value: numericLow, cell: lowCell });
                }

                const mediumCell = row.insertCell();
                const mediumValue = estimatedValues.medium || 'N/A';
                // Apply abbreviation if the value is a number
                mediumCell.textContent = isNaN(parseCurrencyToNumber(mediumValue)) ? mediumValue : formatCurrencyAbbreviated(parseCurrencyToNumber(mediumValue));
                mediumCell.className = 'py-2 px-4 border-b border-gray-200';

                const highCell = row.insertCell();
                const highValue = estimatedValues.high || 'N/A';
                // Apply abbreviation if the value is a number
                highCell.textContent = isNaN(parseCurrencyToNumber(highValue)) ? highValue : formatCurrencyAbbreviated(parseCurrencyToNumber(highValue));
                highCell.className = 'py-2 px-4 border-b border-gray-200';
                const numericHigh = parseCurrencyToNumber(highValue);
                if (!isNaN(numericHigh)) {
                    highValuesForBolding.push({ value: numericHigh, cell: highCell });
                }
            }

            function highlightMinMaxValues() {
                if (lowValuesForBolding.length > 0) {
                    const minLowValue = Math.min(...lowValuesForBolding.map(item => item.value));
                    lowValuesForBolding.forEach(item => {
                        if (item.value === minLowValue) {
                            item.cell.classList.add('bold-value');
                        }
                    });
                }
                if (highValuesForBolding.length > 0) {
                    const maxHighValue = Math.max(...highValuesForBolding.map(item => item.value));
                    highValuesForBolding.forEach(item => {
                        if (item.value === maxHighValue) {
                            item.cell.classList.add('bold-value');
                        }
                    });
                }
            }

            searchButton.addEventListener('click', async () => {
                const address = addressInput.value.trim();
                urlList.innerHTML = '';
                errorMessage.textContent = '';
                estimatedValuesTableBody.innerHTML = '';
                estimatedValuesSummary.innerHTML = '';
                estimatedValuesSummary.style.display = 'none';
                summaryDataContainer.style.display = 'none';
                summaryPhotoWrapper.innerHTML = '';
                summaryTextContent.innerHTML = '';
                resultsSection.style.display = 'none';
                introductoryText.style.display = 'none'; // Hide introductory text on search
                lowValuesForBolding = [];
                highValuesForBolding = [];

                if (address === '') {
                    errorMessage.textContent = 'Please enter an address.';
                    return;
                }

                loadingSpinner.style.display = 'block';
                searchButton.disabled = true;

                const apiEndpoints = [
                    { siteName: "RealEstate.co.nz", url: '/api/get-realestate-url', scrapeValuesUrl: '/api/scrape-realestate-values' },
                    { siteName: "OneRoof.co.nz", url: '/api/get-oneroof-url', scrapeValuesUrl: '/api/scrape-oneroof-values' },
                    { siteName: "Homes.co.nz", url: '/api/get-homes-url', scrapeValuesUrl: '/api/scrape-homes-values' },
                    { siteName: "TradeMe.co.nz", url: '/api/get-trademe-url' },
                    { siteName: "QV.co.nz", url: '/api/get-qv-url', scrapeValuesUrl: '/api/scrape-qv-values' }, // MODIFIED LINE
                    { siteName: "PropertyValue.co.nz", url: '/api/get-propertyvalue-url', scrapeValuesUrl: '/api/scrape-propertyvalue-values' }
                ];

                const fetchPromises = apiEndpoints.map(apiInfo => async () => {
                    let siteUrl = null;
                    let urlError = null;
                    let estimatedValues = { low: 'N/A', medium: 'N/A', high: 'N/A' };
                    let scrapedData = null; // To hold additional scraped data for PropertyValue.co.nz

                    try {
                        // First, fetch the URL for the site
                        const urlResponse = await fetch(apiInfo.url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ address })
                        });
                        const urlResult = await urlResponse.json();

                        if (urlResponse.ok) {
                            siteUrl = urlResult.url;
                            if (apiInfo.siteName === "PropertyValue.co.nz" && urlResult.data) {
                                scrapedData = urlResult.data; // Store additional data if available
                            }
                        } else {
                            urlError = urlResult.error || `Failed to get URL for ${apiInfo.siteName}.`;
                            console.error(`Error fetching URL for ${apiInfo.siteName}:`, urlResult.error);
                        }

                        // If a scrapeValuesUrl is provided and a siteUrl was successfully retrieved,
                        // then proceed to scrape estimated values.
                        if (apiInfo.scrapeValuesUrl && siteUrl && !urlError) {
                            const scrapeResponse = await fetch(apiInfo.scrapeValuesUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ url: siteUrl })
                            });
                            const scrapeResult = await scrapeResponse.json();

                            if (scrapeResponse.ok && scrapeResult.estimatedValues) {
                                estimatedValues = scrapeResult.estimatedValues;
                            } else {
                                console.warn(`Failed to scrape values for ${apiInfo.siteName}:`, scrapeResult.error || 'Unknown error');
                                estimatedValues = { low: 'Error', medium: 'Error', high: 'Error' }; // Mark values as error
                            }
                        }

                    } catch (error) {
                        console.error(`Error processing ${apiInfo.siteName}:`, error);
                        urlError = `Error: ${error.message || 'Network or internal error'}`;
                        estimatedValues = { low: 'Error', medium: 'Error', high: 'Error' };
                    } finally {
                        // Add link to UI (even if there was an error)
                        addLinkToUI(apiInfo.siteName, siteUrl || urlError, !siteUrl, scrapedData);
                        
                        // Display estimated values if available
                        if (estimatedValues.low !== 'N/A' || estimatedValues.medium !== 'N/A' || estimatedValues.high !== 'N/A') {
                            displayEstimatedValues(apiInfo.siteName, siteUrl, estimatedValues, urlError);
                        }
                    }
                });

                try {
                    await Promise.all(fetchPromises.map(p => p())); // Execute all fetches in parallel
                    highlightMinMaxValues(); // Call this after all values are displayed

                    // Collect all medium values for summary
                    const mediumValues = [];
                    const qvData = []; // To store QV specific data
                    let propertyValueData = null; // To store PropertyValue.co.nz data

                    for (const apiInfo of apiEndpoints) {
                        const siteName = apiInfo.siteName;
                        // Access the scraped data from the results
                        const result = await (await fetch(apiInfo.url, { // Re-fetch to get the stored data
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ address })
                        })).json();

                        if (result.url && apiInfo.scrapeValuesUrl) {
                            const scrapeResult = await (await fetch(apiInfo.scrapeValuesUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ url: result.url })
                            })).json();

                            if (scrapeResult.estimatedValues && scrapeResult.estimatedValues.medium && scrapeResult.estimatedValues.medium !== 'N/A' && scrapeResult.estimatedValues.medium !== 'Error') {
                                const numericMedium = parseCurrencyToNumber(scrapeResult.estimatedValues.medium);
                                if (!isNaN(numericMedium)) {
                                    mediumValues.push(numericMedium);
                                }
                            }

                            if (siteName === "QV.co.nz" && scrapeResult.estimatedValues && scrapeResult.estimatedValues.medium !== 'N/A' && scrapeResult.estimatedValues.medium !== 'Error') {
                                qvData.push(parseCurrencyToNumber(scrapeResult.estimatedValues.medium));
                            }
                        }
                        
                        if (siteName === "PropertyValue.co.nz" && result.data) {
                            propertyValueData = result.data;
                        }
                    }

                    // --- Summary Data Display ---
                    let pvDataFound = false;
                    if (propertyValueData) {
                        pvDataFound = true;
                        summaryPhotoWrapper.innerHTML = propertyValueData.propertyPhotoSrc !== 'N/A' ?
                            `<img src="${propertyValueData.propertyPhotoSrc}" alt="Property Photo" class="w-full h-48 object-cover rounded-lg mb-4">` :
                            `<div class="w-full h-48 bg-gray-200 rounded-lg flex items-center justify-center text-gray-500">No Photo Available</div>`;
                        
                        let lastSoldHtml = '';
                        if (propertyValueData.lastSold && propertyValueData.lastSold !== 'N/A' && propertyValueData.lastSold !== 'Not Found on Page') {
                            lastSoldHtml = `<div class="mb-2"><span class="font-bold">Last Sold:</span> ${propertyValueData.lastSold}</div>`;
                        }

                        let valuationDataHtml = '';
                        if (propertyValueData.capitalValue !== 'N/A' && propertyValueData.capitalValue !== 'Not Found on Page') {
                            valuationDataHtml += `<div class="mb-1"><span class="font-bold">Capital Value:</span> ${propertyValueData.capitalValue}</div>`;
                        }
                        if (propertyValueData.landValue !== 'N/A' && propertyValueData.landValue !== 'Not Found on Page') {
                            valuationDataHtml += `<div class="mb-1"><span class="font-bold">Land Value:</span> ${propertyValueData.landValue}</div>`;
                        }
                        if (propertyValueData.improvementValue !== 'N/A' && propertyValueData.improvementValue !== 'Not Found on Page') {
                            valuationDataHtml += `<div class="mb-1"><span class="font-bold">Improvement Value:</span> ${propertyValueData.improvementValue}</div>`;
                        }
                        if (propertyValueData.valuationDate !== 'N/A' && propertyValueData.valuationDate !== 'Not Found on Page') {
                            valuationDataHtml += `<div class="mb-2"><span class="font-bold">Valuation Date:</span> ${propertyValueData.valuationDate}</div>`;
                        }

                        summaryTextContent.innerHTML = `
                            ${lastSoldHtml}
                            ${valuationDataHtml}
                        `;
                    }

                    let anyLinkGenerated = urlList.children.length > 0;

                    if (mediumValues.length > 0) {
                        const sumMedium = mediumValues.reduce((a, b) => a + b, 0);
                        const averageMedium = sumMedium / mediumValues.length;

                        // Display the average
                        let averageHtml = `<div class="p-2"><span class="font-bold">Average Estimated Value:</span> <span class="text-lg font-bold text-blue-700 ml-2">${formatCurrencyAbbreviated(averageMedium)}</span></div>`;
                        
                        // Calculate and display rate of return using QV and average medium values
                        let rateOfReturnHtml = 'N/A';
                        if (qvData.length > 0 && averageMedium > 0) {
                            const qvMediumValue = qvData[0]; // Assuming QV provides a single medium value
                            if (!isNaN(qvMediumValue) && qvMediumValue > 0) {
                                const difference = averageMedium - qvMediumValue;
                                const rate = (difference / qvMediumValue) * 100;
                                rateOfReturnHtml = `${rate.toFixed(2)}%`;
                            }
                        }

                        let summaryContentHtml = `
                            ${averageHtml}
                            <div class="p-2 flex items-center">
                                <span class="font-bold">Annual Return:</span>
                                <span class="text-lg font-bold text-green-700 ml-2">
                                    ${rateOfReturnHtml}
                                </span>
                            </div>
                        `;

                        estimatedValuesSummary.innerHTML = summaryContentHtml;
                        estimatedValuesSummary.style.display = 'flex';
                    }

                    if (pvDataFound) {
                        summaryDataContainer.style.display = 'flex';
                    }

                    if (anyLinkGenerated || mediumValues.length > 0 || pvDataFound) { 
                        resultsSection.style.display = 'block';
                    }

                    if (!anyLinkGenerated && !pvDataFound && mediumValues.length === 0) {
                        errorMessage.textContent = 'No property links, summary data, or estimated values could be generated for the given address from any site.';
                         introductoryText.style.display = 'block'; 
                    }

                } catch (error) {
                    console.error('Overall error during link generation:', error);
                    errorMessage.textContent = error.message || 'An unexpected overall error occurred during link generation.';
                     introductoryText.style.display = 'block'; 
                } finally {
                    loadingSpinner.style.display = 'none';
                    searchButton.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
